---
layout: post
title:  "[ROS] TF(transform) - 2. Using urdf in ROS"
date:   2022-04-07
category: ROS
---

## Intro.
ROS에서 tf에 관한 내용을 총 4개의 글로 작성하려고 한다. 이 글은 그 중 두 번째인 urdf 이다. 

## urdf란?
1편에서 언급한 TF 내용을 떠올려보자. 같은 센서 구성을 A패키지에서 정의할 때, B패키지에서 정의할 때 또는 C사람이 구현할 때, D사람이 구현할 때마다 저마다의 방법으로 한다면 통일성도 없고, 할 때마다 새로운 방법으로 정의될 수 있다. 하지만 이 
<span style="color:#f92672">urdf</span> 란 것을 이용하면, 어떤 프로그램, 누가 코드를 짜더라도 같은 방식으로 진행할 수 있다.

urdf는 **Unified Robot Description Format**의 줄임말로써 **통합 로봇 설명 형식**으로 해석이 된다. 즉, 이 urdf 파일로 정의된 센서 구성을 프로그램에서 불러오면, 통합된 로봇 설명 형식으로써 모두가 같은 방법으로 센서 구성을 읽어올 수 있고 사용할 수 있게 된다.

## Example
나는 cyglidar와 realsense 두 개를 사용할 것이다. 이 때 각각의 센서는 다음과 같이 위치한다. 로봇 중심축(chassis_link)을 기준으로 cyglidar(laser_link)는 
<span style="color:#f92672">[0.5, 0.15, 0.74]</span> 만큼 translation 되어있고, rotation은 없다. 중심축(chassis_link)을 기준으로 realsense(camera_depth_optical_frame)는 <span style="color:#f92672">[0.5, -0.15, 0.74]</span> 만큼 translation 되어있고, <span style="color:#f92672">[r=-1.57, p=0, y=-1.57]</span> 만큼 rotation 되어있다. 모든 단위는 meter, radian이다.

<center>
<figure>
	<img src="/public/img/ros/ros-tf2-1.png" alt="" width="20%" height="20%"> 
    <img src="/public/img/ros/ros-tf2-2.png" alt="" width="20%" height="20%"> 
    <img src="/public/img/ros/ros-tf2-3.png" alt="" width="20%" height="20%"> 
    <img src="/public/img/ros/ros-tf2-topview.png" alt="" width="20%" height="20%"> 
	<figcaption>Fig1. - Sensors Configuration.</figcaption>
</figure>
</center>

(RVIZ에서 x,y,z축을 쉽게 기억하는 방법은 RGB 순서를 기억하면 된다. R=X축, G=Y축, B=Z축이다!)

이 때, urdf는 아래와 같이 작성한다.
```xml
<?xml version="1.0" ?>
<!-- =================================================================================== -->
<!-- |    This document was autogenerated by xacro from robot.urdf.xacro               | -->
<!-- |    EDITING THIS FILE BY HAND IS NOT RECOMMENDED                                 | -->
<!-- =================================================================================== -->
<robot name="My Robot" xmlns:xacro="http://ros.org/wiki/xacro">
  <link name="base_link"/>
  <joint name="base_joint" type="fixed">
    <origin rpy="0 0 0" xyz="0 0 0"/>
    <parent link="base_link"/>
    <child link="chassis_link"/>
  </joint>

  <link name="chassis_link">
  </link>

  <!--cyglidar-->
  <link name="laser_link"/>
  <joint name="laser_joint" type="fixed">
    <origin rpy="0 0 0" xyz="0.5 0.15 0.74"/>
    <parent link="chassis_link"/>
    <child link="laser_link"/>
  </joint>

  <!--realsense-->
  <link name="camera_depth_optical_frame"/>
   <joint name="camera_depth_optical_frame_joint" type="fixed">
    <origin rpy="-1.57 0 -1.57" xyz="0.5 -0.15 0.74"/>
    <parent link="chassis_link"/>
    <child link="camera_depth_optical_frame"/>
  </joint>
</robot>
```

## 사용법
사용자가 센서의 위치를 정의해 줄 것은 link 또는 joint이다. 그리고 각 센서는 어떤 구조로 (parent, child)로 묶여 있고, 어떤 위치에 있는가(rpy,xyz) 이다. 아래 그림은 ros wiki의 urdf를 설명하는 그림에서 가져왔다.

<center>
<figure>
	<img src="/public/img/ros/link.png" alt="" width="30%" height="30%"> 
	<figcaption>Fig2. - Link and Joint.</figcaption>
</figure>
</center>

### 1. link 또는 joint
<span style="color:#f92672">link</span>는 쉽게 생각해서 하나의 센서가 운용되는 독립된 공간이라고 생각하면 된다. 만약 카메라를 사용한다면 카메라로부터 얻은 이미지가 표현되는 공간을 <span style="color:#f92672">link</span>로 생각할 수 있다. 만약 로봇팔이 움직인다면, 로봇팔 부분이 움직일 수 있는 공간을 link로 생각할 수 있다.

<span style="color:#f92672">joint</span>는 링크와 링크 사이에 연결된 부분으로 어떤 중심축(parent)으로부터 다른 축(child)간의 연결을 나타낸다. 그렇기 때문에 누가 중심 축인지, 중심축으로부터 얼만큼 translation, rotation이 있는지를 나타내야 한다. 위의 urdf예제에서 <span style="color:#f92672">origin rpy="-1.57 0 -1.57" xyz="0.5 -0.15 0.74"</span> 이 각각 rotation, translation을 나타낸다.

### 2. parent, child
말그대로 부모, 자식이다. 누가 더 윗사람인가. 누가 더 중심축인가. 나의 경우 사용하려는 두 센서(cyglidar, realsense)를 모두 로봇 중심축으로 옮겨놓고 사용할 것이다. 즉, 로봇의 중심이 중심축이므로 <span style="color:#f92672">chassis_link</span>가 <span style="color:#f92672">parenet</span>이다. cyglidar, realsense는 그러므로 <span style="color:#f92672">child</span>이다.


만약 realsense camera를 cyglidar로 축이동을 시키고 싶다면 parent는 cyglidar, child는 realsense로 하면된다. 내가 축을 통일하고자 하는 곳에 parent, child를 적으면 된다.

### 3. link name
link name을 아무렇게나 만들면 안된다. 우리가 사용하려는 센서를 실행시키면 frame_id를 얻을 수 있는데 그 이름을 적어야 한다.
예를들어 realsense의 경우 이미지 및 포인트 클라우드를 사용하기 위하여 다음과 같이 실행을 한다.
```bash
roslaunch realsense2_camera rs_camera.launch depth_width:=1280 depth_height:=720 color_width:=1280 color_height:=720 depth_fps:=30 color_fps:=30 enable_pointcloud:=true
```

```bash
rostopic list
```
를 하면 많은 토픽이 보이지만, 내가 사용할 3차원 pcd는 `/camera/depth/color/points` 이다. 이 topic의 frame_id를 확인해야 한다.
단순히 `rostopic echo /camera/depth/color/points`를 하게 되면 너무 빠르게 데이터가 넘어가기 때문에 나는 다음과 같은 방식으로 확인한다.
```bash
rostopic echo /camera/depth/color/points >> 1.txt
```
이렇게 하면 1.txt 파일 안에 해당 토픽의 내용이 저장된다. 확인하면 다음과 같다.
```
header: 
  seq: 572
  stamp: 
    secs: 1649313120
    nsecs: 681468010
  frame_id: "camera_depth_optical_frame"
...
중략
...
```
저기서 얻은 frame_id를 link_name으로 적어야 한다.

### 4. translation
parent를 기준 축으로 두고 child가 얼만큼 translation되어 있는지 적으면 된다.
나의 경우 중심축 기준으로 realsense는 앞으로(x축) 0.5m, 왼쪽으로(y축) -0.15m, 위로(z축) 0.74m 떨어져 있기 때문에 <span style="color:#f92672">[0.5, -0.15, 0.74]</span>이라 적는다.

### 5. rotation
realsense는 아래 그림과 같이 parent를 기준 축으로 두고, parent를 Z축으로 -1.57rad (-90º) 회전하고, 회전한 후 변경된 X축으로 -1.57rad (-90º) 회전하면 child의 축과 같아진다. 이 때 회전순서는 반드시 <span style="color:#f92672">Z → Y → X 축 순서</span>로 회전을 해야 한다. (matrix 곱형태로는 $R_Z * R_Y * R_X$ 순서가 될것이다.) R matrix는 다음과 같다.

<center>
<figure>
    <img src="/public/img/ros/ros-tf2-coord_change.png" alt="" width="40%" height="40%"> 
	<figcaption>Fig3. - Coordinate Changes.</figcaption>
</figure>
</center>

$R = R_Z(-90) \times R_Y(0) \times R_X(-90) \\
 = \begin{bmatrix} cos(-90) & -sin(-90) & 0 \cr sin(-90) & cos(-90) & 0 \cr 0 & 0 & 1 \end{bmatrix} \times \begin{bmatrix} 1 & 0 & 0 \cr 0 & cos(-90) & -sin(-90) \cr 0 & sin(-90) & cos(-90) \end{bmatrix} \\ = \begin{bmatrix} 0 & 1 & 0 \cr -1 & 0 & 0 \cr 0 & 0 & 1 \end{bmatrix} \times \begin{bmatrix} 1 & 0 & 0 \cr 0 & 0 & 1 \cr 0 & -1 & 0 \end{bmatrix} = \begin{bmatrix} 0 & 0 & 1 \cr -1 & 0 & 0 \cr 0 & -1 & 0 \end{bmatrix}$

## 결론
다시 정리하면, 
1. parent, child 관계를 잘 정립한다.
2. parent를 기준으로, parent 축을 child 축으로 옮긴다고 생각하고 translation, rotation 을 각각 rpy,xyz로 적는다.


## 출처.
- [http://wiki.ros.org/urdf/Tutorials](http://wiki.ros.org/urdf/Tutorials)
- [http://wiki.ros.org/urdf/Tutorials/Create%20your%20own%20urdf%20file](http://wiki.ros.org/urdf/Tutorials/Create%20your%20own%20urdf%20file)

---
## 관련글.
1. [[ROS] TF(transform) - 1. Prerequisite](https://undol26.github.io/ros/2022/03/29/ros-tf1.html)
2. [[ROS] TF(transform) - 2. Using urdf in ROS](https://undol26.github.io/ros/2022/04/07/ros-tf2.html)